<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>抽丝剥茧般的阅读源码，将$nextTick()拉下神坛！ | zhangwinwin&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">
    <link rel="stylesheet" href="https://gitcdn.xyz/cdn/goessner/markdown-it-texmath/master/texmath.css">
    <script src="https://github.com/markdown-it/markdown-it/blob/master/bin/markdown-it.js"></script>
    <script src="https://gitcdn.xyz/cdn/goessner/markdown-it-texmath/master/texmath.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
    <meta name="description" content="some technical articles on programming, especially webgl">
    
    <link rel="preload" href="/FEBlog/assets/css/0.styles.d6193a66.css" as="style"><link rel="preload" href="/FEBlog/assets/js/app.b158500d.js" as="script"><link rel="preload" href="/FEBlog/assets/js/2.7d7fb6cb.js" as="script"><link rel="preload" href="/FEBlog/assets/js/30.68fadd92.js" as="script"><link rel="prefetch" href="/FEBlog/assets/js/10.f2a2cc76.js"><link rel="prefetch" href="/FEBlog/assets/js/11.9d2c86e2.js"><link rel="prefetch" href="/FEBlog/assets/js/12.b8ebcb32.js"><link rel="prefetch" href="/FEBlog/assets/js/13.c4ca47c5.js"><link rel="prefetch" href="/FEBlog/assets/js/14.a3911fae.js"><link rel="prefetch" href="/FEBlog/assets/js/15.f3798b20.js"><link rel="prefetch" href="/FEBlog/assets/js/16.3988fd0d.js"><link rel="prefetch" href="/FEBlog/assets/js/17.a3bff097.js"><link rel="prefetch" href="/FEBlog/assets/js/18.0402de45.js"><link rel="prefetch" href="/FEBlog/assets/js/19.64dfd7bd.js"><link rel="prefetch" href="/FEBlog/assets/js/20.8ae18d54.js"><link rel="prefetch" href="/FEBlog/assets/js/21.686fbff4.js"><link rel="prefetch" href="/FEBlog/assets/js/22.f37786bd.js"><link rel="prefetch" href="/FEBlog/assets/js/23.d01475c6.js"><link rel="prefetch" href="/FEBlog/assets/js/24.b50cb274.js"><link rel="prefetch" href="/FEBlog/assets/js/25.dec00c3c.js"><link rel="prefetch" href="/FEBlog/assets/js/26.be064a51.js"><link rel="prefetch" href="/FEBlog/assets/js/27.204b551b.js"><link rel="prefetch" href="/FEBlog/assets/js/28.843b63a9.js"><link rel="prefetch" href="/FEBlog/assets/js/29.58e09b07.js"><link rel="prefetch" href="/FEBlog/assets/js/3.65fb9823.js"><link rel="prefetch" href="/FEBlog/assets/js/31.da110779.js"><link rel="prefetch" href="/FEBlog/assets/js/32.fd8ecdbf.js"><link rel="prefetch" href="/FEBlog/assets/js/33.ab43cbf0.js"><link rel="prefetch" href="/FEBlog/assets/js/34.9eb09d94.js"><link rel="prefetch" href="/FEBlog/assets/js/35.d24309ed.js"><link rel="prefetch" href="/FEBlog/assets/js/36.2b760384.js"><link rel="prefetch" href="/FEBlog/assets/js/37.cf57d516.js"><link rel="prefetch" href="/FEBlog/assets/js/38.ebd67282.js"><link rel="prefetch" href="/FEBlog/assets/js/39.390dc348.js"><link rel="prefetch" href="/FEBlog/assets/js/4.6e58adc1.js"><link rel="prefetch" href="/FEBlog/assets/js/40.9dba16d5.js"><link rel="prefetch" href="/FEBlog/assets/js/41.a3240bd5.js"><link rel="prefetch" href="/FEBlog/assets/js/42.eb5be3bf.js"><link rel="prefetch" href="/FEBlog/assets/js/43.730ebcf4.js"><link rel="prefetch" href="/FEBlog/assets/js/44.ccc62d57.js"><link rel="prefetch" href="/FEBlog/assets/js/45.ad1d828c.js"><link rel="prefetch" href="/FEBlog/assets/js/46.5b36dcbd.js"><link rel="prefetch" href="/FEBlog/assets/js/47.4a801f44.js"><link rel="prefetch" href="/FEBlog/assets/js/48.7e166c43.js"><link rel="prefetch" href="/FEBlog/assets/js/49.23c05926.js"><link rel="prefetch" href="/FEBlog/assets/js/5.720089dd.js"><link rel="prefetch" href="/FEBlog/assets/js/50.4e03a0f5.js"><link rel="prefetch" href="/FEBlog/assets/js/51.e42c88ba.js"><link rel="prefetch" href="/FEBlog/assets/js/52.f07316b9.js"><link rel="prefetch" href="/FEBlog/assets/js/53.eb8ab9b1.js"><link rel="prefetch" href="/FEBlog/assets/js/54.4cd69611.js"><link rel="prefetch" href="/FEBlog/assets/js/55.d67f2251.js"><link rel="prefetch" href="/FEBlog/assets/js/56.0e8e4426.js"><link rel="prefetch" href="/FEBlog/assets/js/57.e6a8e7d6.js"><link rel="prefetch" href="/FEBlog/assets/js/58.4cf7f096.js"><link rel="prefetch" href="/FEBlog/assets/js/59.fd6482f8.js"><link rel="prefetch" href="/FEBlog/assets/js/6.837ac311.js"><link rel="prefetch" href="/FEBlog/assets/js/60.3ce8a368.js"><link rel="prefetch" href="/FEBlog/assets/js/61.3162b2a8.js"><link rel="prefetch" href="/FEBlog/assets/js/62.ced16e8f.js"><link rel="prefetch" href="/FEBlog/assets/js/63.645bd795.js"><link rel="prefetch" href="/FEBlog/assets/js/64.4f65269b.js"><link rel="prefetch" href="/FEBlog/assets/js/65.14527b40.js"><link rel="prefetch" href="/FEBlog/assets/js/66.e572cb43.js"><link rel="prefetch" href="/FEBlog/assets/js/7.f30bf9bf.js"><link rel="prefetch" href="/FEBlog/assets/js/8.2380c336.js"><link rel="prefetch" href="/FEBlog/assets/js/9.f775cc22.js">
    <link rel="stylesheet" href="/FEBlog/assets/css/0.styles.d6193a66.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/FEBlog/" class="home-link router-link-active"><!----> <span class="site-name">zhangwinwin's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/FEBlog/" class="nav-link">
  Intro
</a></div><div class="nav-item"><a href="/FEBlog/webgl/" class="nav-link">
  Webgl
</a></div><div class="nav-item"><a href="/FEBlog/frontend/" class="nav-link router-link-active">
  Frontend
</a></div><div class="nav-item"><a href="/FEBlog/network/" class="nav-link">
  Network
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客地址" class="dropdown-title"><span class="title">博客地址</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客地址" class="mobile-dropdown-title"><span class="title">博客地址</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhangwinwin/FEBlog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/1486195453331757" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/FEBlog/" class="nav-link">
  Intro
</a></div><div class="nav-item"><a href="/FEBlog/webgl/" class="nav-link">
  Webgl
</a></div><div class="nav-item"><a href="/FEBlog/frontend/" class="nav-link router-link-active">
  Frontend
</a></div><div class="nav-item"><a href="/FEBlog/network/" class="nav-link">
  Network
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客地址" class="dropdown-title"><span class="title">博客地址</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客地址" class="mobile-dropdown-title"><span class="title">博客地址</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/zhangwinwin/FEBlog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/1486195453331757" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size:16px;padding:0 10px;word-spacing:0px;word-break:break-word;word-wrap:break-word;text-align:left;margin-top:-10px;line-height:1.75;color:#595959;font-family:Optima-Regular, Optima, PingFangTC-Light, PingFangSC-light, PingFangTC-light;letter-spacing:2px;background-image:linear-gradient(90deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%), linear-gradient(360deg, rgba(50, 0, 0, 0.05) 3%, rgba(0, 0, 0, 0) 3%);background-size:20px 20px;background-position:center center;"><blockquote data-tool="mdnice编辑器" style="display:block;font-size:0.9em;overflow:auto;overflow-scrolling:touch;padding-top:10px;padding-bottom:10px;padding-left:20px;padding-right:10px;margin-bottom:20px;margin-top:20px;text-size-adjust:100%;line-height:1.55em;font-weight:400;border-radius:6px;color:#595959;font-style:normal;text-align:left;box-sizing:inherit;border-left:none;border:1px solid #DEC6FB;background:#F6EEFF;"><span style="color:#DEC6FB;font-size:34px;line-height:1;font-weight:700;">❝</span> <p style="padding-top:8px;padding-bottom:8px;letter-spacing:2px;font-size:14px;word-spacing:2px;margin:0px;line-height:26px;color:#595959;">    古人云：知其然知其所以然</p><span style="color:#DEC6FB;font-size:34px;line-height:1;font-weight:700;float:right;">❞</span></blockquote> <h2 data-tool="mdnice编辑器" style="margin-top:30px;margin-bottom:15px;padding:0px;font-weight:bold;color:black;font-size:22px;text-align:left;margin:20px 10px 0px 0px;"><span class="prefix" style="display:none;"></span><span class="content" style="font-size:18px;font-weight:bold;display:inline-block;padding-left:10px;border-left:5px solid #DEC6FB;color:#595959;">前言</span><span class="suffix"></span></h2> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">相信有很多开发第一次碰到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">vue</code>中的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick()</code>时都会把它当作一次<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout()</code>调用。这个理解是对的吗？</p> <h3 data-tool="mdnice编辑器" style="margin-top:30px;margin-bottom:15px;padding:0px;color:black;font-size:16px;font-weight:bold;text-align:center;"><span class="prefix" style="display:none;"></span><span class="content" style="border-bottom:2px solid #DEC6FB;color:#595959;">1. 前置知识</span><span class="suffix" style="display:none;"></span></h3> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">这个方法理解起来并不难，但需要知道下面的概念：</p> <ul data-tool="mdnice编辑器" style="margin-top:8px;margin-bottom:8px;padding-left:25px;font-size:15px;color:#595959;list-style-type:circle;"><li><section style="margin-top:5px;margin-bottom:5px;line-height:26px;text-align:left;font-size:14px;font-weight:normal;color:#595959;">调用栈</section></li><li><section style="margin-top:5px;margin-bottom:5px;line-height:26px;text-align:left;font-size:14px;font-weight:normal;color:#595959;">任务队列</section></li><li><section style="margin-top:5px;margin-bottom:5px;line-height:26px;text-align:left;font-size:14px;font-weight:normal;color:#595959;">事件循环</section></li></ul> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">下面假设大家对这些概念已经非常清楚了。</p> <h2 data-tool="mdnice编辑器" style="margin-top:30px;margin-bottom:15px;padding:0px;font-weight:bold;color:black;font-size:22px;text-align:left;margin:20px 10px 0px 0px;"><span class="prefix" style="display:none;"></span><span class="content" style="font-size:18px;font-weight:bold;display:inline-block;padding-left:10px;border-left:5px solid #DEC6FB;color:#595959;">$nextTick()</span><span class="suffix"></span></h2> <h3 data-tool="mdnice编辑器" style="margin-top:30px;margin-bottom:15px;padding:0px;color:black;font-size:16px;font-weight:bold;text-align:center;"><span class="prefix" style="display:none;"></span><span class="content" style="border-bottom:2px solid #DEC6FB;color:#595959;">1. 概念</span><span class="suffix" style="display:none;"></span></h3> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">掌握一个知识点的背后原理，就必须对它的使用要非常熟悉。来看官方的介绍。</p> <blockquote data-tool="mdnice编辑器" style="display:block;font-size:0.9em;overflow:auto;overflow-scrolling:touch;padding-top:10px;padding-bottom:10px;padding-left:20px;padding-right:10px;margin-bottom:20px;margin-top:20px;text-size-adjust:100%;line-height:1.55em;font-weight:400;border-radius:6px;color:#595959;font-style:normal;text-align:left;box-sizing:inherit;border-left:none;border:1px solid #DEC6FB;background:#F6EEFF;"><span style="color:#DEC6FB;font-size:34px;line-height:1;font-weight:700;">❝</span> <p style="padding-top:8px;padding-bottom:8px;letter-spacing:2px;font-size:14px;word-spacing:2px;margin:0px;line-height:26px;color:#595959;">vm.$nextTick([callback])</p> <ul style="margin-top:8px;margin-bottom:8px;padding-left:25px;font-size:15px;color:#595959;list-style-type:circle;"><li><section style="margin-top:5px;margin-bottom:5px;line-height:26px;text-align:left;font-size:14px;font-weight:normal;color:#595959;">参数：{function} [callback]</section></li><li><section style="margin-top:5px;margin-bottom:5px;line-height:26px;text-align:left;font-size:14px;font-weight:normal;color:#595959;">用法：将回调延迟到下次<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>更新循环之后执行。在修改数据之后立即使用它，然后等待<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>更新。回调的this自动绑定到调用它的实例上。</section></li></ul> <span style="float:right;color:#DEC6FB;">❞</span></blockquote> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">new Vue({
<span></span>  // ...
<span></span>  methods: {
<span></span>    // ...
<span></span>    example: <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {
<span></span>      // 修改数据
<span></span>      this.message = <span class="hljs-string" style="color:#D69D85;line-height:26px;">'changed'</span>
<span></span>      // DOM 还没有更新
<span></span>      this.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span>(<span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {
<span></span>        // DOM 现在更新了
<span></span>        // `this` 绑定到当前实例
<span></span>        this.doSomethingElse()
<span></span>      })
<span></span>    }
<span></span>  }
<span></span>})
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">上面有一句话说&quot;<strong style="color:#595959;font-weight:bold;"><span>「</span>将回调延迟到下次<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>更新循环之后在执行<span>」</span></strong>&quot;。这句话的意思是：</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Vue</code>在更新<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>时是异步执行的。只要侦听到数据变化，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Vue</code>将开启一个队列，并缓冲在同一事件循环中发生的所有数据变更。如果同一个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">watcher</code>被多次触发，只会被推入到队列中一次。然后，在下一个的事件循环中，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Vue</code>刷新队列并执行实际的工作。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">例如，当设置<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">vm.someData = 'new value'</code>，该组件不会立即重新渲染。当刷新队列时，组件会在下一个事件循环中更新。但是如果想基于更新后的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>状态来做点什么，这就有点难办了。所以Vue就推出了<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick()</code>，此方法接收的回调函数将在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>更新完成后被调用。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Vue</code>文档上也写了：</p> <blockquote data-tool="mdnice编辑器" style="display:block;font-size:0.9em;overflow:auto;overflow-scrolling:touch;padding-top:10px;padding-bottom:10px;padding-left:20px;padding-right:10px;margin-bottom:20px;margin-top:20px;text-size-adjust:100%;line-height:1.55em;font-weight:400;border-radius:6px;color:#595959;font-style:normal;text-align:left;box-sizing:inherit;border-left:none;border:1px solid #DEC6FB;background:#F6EEFF;"><span style="color:#DEC6FB;font-size:34px;line-height:1;font-weight:700;">❝</span> <p style="padding-top:8px;padding-bottom:8px;letter-spacing:2px;font-size:14px;word-spacing:2px;margin:0px;line-height:26px;color:#595959;"><code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Vue</code>在内部对异步队列尝试使用原生的 <code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Promise.then</code>、<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MutationObserver</code> 和 <code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setImmediate</code>，如果执行环境不支持，则会采用 <code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout(fn, 0)</code> 代替。</p> <span style="float:right;color:#DEC6FB;">❞</span></blockquote> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">所以将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick()</code>当作一次<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout()</code>调用，并不能说是错的。只是没有那么准确。</p> <h3 data-tool="mdnice编辑器" style="margin-top:30px;margin-bottom:15px;padding:0px;color:black;font-size:16px;font-weight:bold;text-align:center;"><span class="prefix" style="display:none;"></span><span class="content" style="border-bottom:2px solid #DEC6FB;color:#595959;">2. 源码解读</span><span class="suffix" style="display:none;"></span></h3> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick()</code>是在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">/src/core/instance/render.js</code>中定义的：</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">export</span> <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">function</span> renderMixin (Vue: Class&lt;Component&gt;) {
<span></span>  ...
<span></span>  Vue.prototype.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span> = <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">function</span> (fn: Function) {
<span></span>    <span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">return</span> nextTick(fn, this)
<span></span>  }
<span></span>  ...
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick()</code>方法是在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">renderMixin</code>函数中挂载到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Vue</code>原型上的。可以看出<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick()</code>是对<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>函数的简单封装。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">而<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>函数是在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">/src/core/util/next-tick.js</code>中定义的。<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">next-tick.js</code>文件中主体是一段4层<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">if else</code>语句。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">if</span></span> () {
<span></span>    ...
<span></span>} <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">if</span></span> () {
<span></span>    ...
<span></span>} <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">if</span></span> () {
<span></span>    ...
<span></span>} <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> {
<span></span>    ...
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>第一层<span>」</span></strong></p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (typeof Promise !== <span class="hljs-string" style="color:#D69D85;line-height:26px;">'undefined'</span> &amp;&amp; isNative(Promise)) {
<span></span>  const p = Promise.resolve()
<span></span>  timerFunc = () =&gt; {
<span></span>    p.then(flushCallbacks)
<span></span>    // In problematic UIWebViews, Promise.then doesn<span class="hljs-string" style="color:#D69D85;line-height:26px;">'t completely break, but
<span></span>    // it can get stuck in a weird state where callbacks are pushed into the
<span></span>    // microtask queue but the queue isn'</span>t being flushed, until the browser
<span></span>    // needs to <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">do</span> some other work, e.g. handle a timer. Therefore we can
<span></span>    // <span class="hljs-string" style="color:#D69D85;line-height:26px;">&quot;force&quot;</span> the microtask queue to be flushed by adding an empty timer.
<span></span>    <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (isIOS) setTimeout(noop)
<span></span>  }
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">首先判断当前环境支不支持<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Promise</code>，如果支持则优先使用<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Promise</code>。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">总所周知，任务队列并非只有一个队列，总的来说可以将其分为微任务--<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">microtask</code>和宏任务--<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">macrotask</code>。当调用栈空闲后，事件循环就会在宏任务消息队列中读取一个任务并执行。宏任务执行的过程中，有时候会产生多个微任务，将其保存在微任务队列中。也就是说每个宏任务都关联了一个微任务队列。当主函数执行结束之后、当前宏任务结束之前，事件循环就会将当前微任务队列执行并清空。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">另外两个宏任务之间可能穿插着<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">UI</code>的重渲染，那么只需要在微任务中把所有<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">UI</code>重渲染之前把需要更新的数据全部更新，这样只需要一次重渲染就能得到最新的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>了。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">对于<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">vue</code>来说，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">vue</code>是一个数据驱动的框架，要是能在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">UI</code>重渲染之前更新所有数据状态，这对性能的提升是一个非常大的帮助，所以要优先使用微任务去更新数据状态而不是宏任务，这就是为什么优先使用<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">promise</code>，而不是<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout</code>的原因。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>接着解读：<span>」</span></strong><br>
首先定义常量 <code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">p</code> 它的值是一个立即 <code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">resolve</code> 的 <code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Promise</code> 实例对象。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">接着将变量 <code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">timerFunc</code> 定义为一个函数，这个函数的执行将会把 <code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code> 函数注册为微任务。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>接着<span>」</span></strong></p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">// In problematic UIWebViews, Promise.then doesn<span class="hljs-string" style="color:#D69D85;line-height:26px;">'t completely break, but
<span></span>// it can get stuck in a weird state where callbacks are pushed into the
<span></span>// microtask queue but the queue isn'</span>t being flushed, until the browser
<span></span>// needs to <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">do</span> some other work, e.g. handle a timer. Therefore we can
<span></span>// <span class="hljs-string" style="color:#D69D85;line-height:26px;">&quot;force&quot;</span> the microtask queue to be flushed by adding an empty timer.
<span></span><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (isIOS) setTimeout(noop)
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">注释说，在一些<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">UIWebViews</code>中微任务没有被刷新，解决方案就是让浏览器做一些其他的事件，比如注册一个宏任务，即使这个宏任务什么都不做，这样就能间接触发微任务的刷新。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>第二层<span>」</span></strong></p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">如果当前环境不支持<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Promise</code>（IE：看我干嘛），走到第二层<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">else if</code>语句中。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (!isIE &amp;&amp; typeof MutationObserver !== <span class="hljs-string" style="color:#D69D85;line-height:26px;">'undefined'</span> &amp;&amp; (
<span></span>  isNative(MutationObserver) ||
<span></span>  // PhantomJS and iOS 7.x
<span></span>  MutationObserver.toString() === <span class="hljs-string" style="color:#D69D85;line-height:26px;">'[object MutationObserverConstructor]'</span>
<span></span>)) {
<span></span>  // Use MutationObserver <span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">where</span> native Promise is not available,
<span></span>  // e.g. PhantomJS, iOS7, Android 4.4
<span></span>  // (<span class="hljs-comment" style="color:#57A64A;font-style:italic;line-height:26px;">#6466 MutationObserver is unreliable in IE11)</span>
<span></span>  <span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">let</span> counter = 1
<span></span>  const observer = new MutationObserver(flushCallbacks)
<span></span>  const textNode = document.createTextNode(String(counter))
<span></span>  observer.observe(textNode, {
<span></span>    characterData: <span class="hljs-literal" style="color:#569CD6;line-height:26px;">true</span>
<span></span>  })
<span></span>  timerFunc = () =&gt; {
<span></span>    counter = (counter + 1) % 2
<span></span>    textNode.data = String(counter)
<span></span>  }
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">判断当前环境是否支持<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MutationObserver</code>。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MutationObserver</code>也是一个微任务，提供了监视对<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>树所做更改的能力。它被设计为旧的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Mutation Events</code>功能的替代品，该功能是<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM3 Events</code>规范的一部分。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">首先将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>传入<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MutationObserver</code>构造函数中，创建并返回一个新的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MutationObserver</code>它会在指定的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>发生变化时被调用。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">const observer = new MutationObserver(flushCallbacks)
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">然后创建一个根据<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">counter</code>变量的文本<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>节点，并配置<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MutationObserver</code>订阅此<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>节点，所以当这个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>节点变化时，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>就会注册在微任务队列。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">let</span> counter = 1
<span></span>const textNode = document.createTextNode(String(counter))
<span></span>observer.observe(textNode, {
<span></span>    characterData: <span class="hljs-literal" style="color:#569CD6;line-height:26px;">true</span>
<span></span>})
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">最后将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">timeFun</code>注册为一个函数，当<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">timeFun</code>执行时，立即更改<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">counter</code>的值，从而引起<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MutationObserver</code>的更改，将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>注册在微任务队列中。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">timerFunc = () =&gt; {
<span></span>    counter = (counter + 1) % 2
<span></span>    textNode.data = String(counter)
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>第三层<span>」</span></strong></p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">接着解读第三层<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">else if</code>语句</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (typeof setImmediate !== <span class="hljs-string" style="color:#D69D85;line-height:26px;">'undefined'</span> &amp;&amp; isNative(setImmediate)) {
<span></span>  // Fallback to setImmediate.
<span></span>  // Techinically it leverages the (macro) task queue,
<span></span>  // but it is still a better choice than setTimeout.
<span></span>  timerFunc = () =&gt; {
<span></span>    setImmediate(flushCallbacks)
<span></span>  }
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">可以看出<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setImmediate</code>函数优先<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout</code>函数。这是因为<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setImmediate</code>比<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout</code>有更好的性能。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout</code>将回调函数注册在宏任务队列中之前要不断的做超时检测，而<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setImmediate</code>不需要。但是<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setImmediate</code>有明显的缺陷，只有<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">IE</code>实现了它。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>第四层<span>」</span></strong></p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">最后第四层<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">else</code>语句，就轮到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout</code>出场了。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> {
<span></span>  // Fallback to setTimeout.
<span></span>  timerFunc = () =&gt; {
<span></span>    setTimeout(flushCallbacks, 0)
<span></span>  }
<span></span>}
<span></span></code></pre> <h3 data-tool="mdnice编辑器" style="margin-top:30px;margin-bottom:15px;padding:0px;color:black;font-size:16px;font-weight:bold;text-align:center;"><span class="prefix" style="display:none;"></span><span class="content" style="border-bottom:2px solid #DEC6FB;color:#595959;">3. 非浏览器环境</span><span class="suffix" style="display:none;"></span></h3> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">翻查源码的过程中，发现<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>函数的定义不只有一处地方。在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">packages/weex-vue-framework/factory.js</code>中也定义了。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">也不难理解，因为上面介绍的都是基于是浏览器环境的，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">weex</code>是运行在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">node</code>环境下的。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">也来看看这个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>定义与上面的有什么不同。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">主体是围绕着<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">mircotask</code>与<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">marcotask</code>进行，也就是分别定义宏任务与微任务。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">var macroTimerFunc;
<span></span><span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">if</span></span> () {
<span></span>    macroTimerFunc = <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {...}
<span></span>} <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">if</span></span> () {
<span></span>    macroTimerFunc = <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {...}
<span></span>} <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> {...}
<span></span>
<span></span>var microTimerFunc;
<span></span><span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">if</span></span> () {
<span></span>    microTimerFunc = <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {...}
<span></span>} <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> {
<span></span>    microTimerFunc = macroTimerFunc
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">可以看到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">macroTimerFunc</code>有三层<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">if</code>判断<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">，microTimerFunc</code>有两层。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>macroTimerFunc<span>」</span></strong></p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">先看<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">macroTimerFunc</code></p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (typeof setImmediate !== <span class="hljs-string" style="color:#D69D85;line-height:26px;">'undefined'</span> &amp;&amp; isNative(setImmediate)) {
<span></span>  macroTimerFunc = <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {
<span></span>    setImmediate(flushCallbacks);
<span></span>  };
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">优先判断当前环境是否支持<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setImmediate</code>，最后的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">else</code>才是使用<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout</code>。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> {
<span></span>  /* istanbul ignore next */
<span></span>  macroTimerFunc = <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {
<span></span>    setTimeout(flushCallbacks, 0);
<span></span>  };
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>MessageChannel<span>」</span></strong></p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">而中间的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">else if</code>是判断是否支持<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MessageChannel</code></p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (typeof MessageChannel !== <span class="hljs-string" style="color:#D69D85;line-height:26px;">'undefined'</span> &amp;&amp; (
<span></span>  isNative(MessageChannel) ||
<span></span>  // PhantomJS
<span></span>  MessageChannel.toString() === <span class="hljs-string" style="color:#D69D85;line-height:26px;">'[object MessageChannelConstructor]'</span>
<span></span>)) {
<span></span>  var channel = new MessageChannel();
<span></span>  var port = channel.port2;
<span></span>  channel.port1.onmessage = flushCallbacks;
<span></span>  macroTimerFunc = <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {
<span></span>    port.postMessage(1);
<span></span>  };
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">了解过<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Web Workers</code>都知道，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Web Workers</code>的内部实现就是用到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MessageChannel</code>。一个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">MessageChannel</code>实例对象拥有两个属性<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">port1</code>和<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">port2</code>，只要让<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">port1</code>监听<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">onmessage</code>事件，然后使用<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">port2</code>的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">postMessage</code>向<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">port1</code>发送消息即可，这样<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">port1</code>的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">onmessage</code>回调就会被注册为宏任务，由于它也不需要任何检测工作，所以性能也比<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">setTimeout</code>要好。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">总之<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">macroTimerFunc</code>函数的作用就是将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>注册为宏任务。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>microTimerFunc<span>」</span></strong></p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">举一反三，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">microTimerFunc</code>函数的作用就是将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>注册为微任务。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (typeof Promise !== <span class="hljs-string" style="color:#D69D85;line-height:26px;">'undefined'</span> &amp;&amp; isNative(Promise)) {
<span></span>  var p = Promise.resolve();
<span></span>  microTimerFunc = <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">function</span></span> () {
<span></span>    p.then(flushCallbacks);
<span></span>    // <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">in</span> problematic UIWebViews, Promise.then doesn<span class="hljs-string" style="color:#D69D85;line-height:26px;">'t completely break, but
<span></span>    // it can get stuck in a weird state where callbacks are pushed into the
<span></span>    // microtask queue but the queue isn'</span>t being flushed, until the browser
<span></span>    // needs to <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">do</span> some other work, e.g. handle a timer. Therefore we can
<span></span>    // <span class="hljs-string" style="color:#D69D85;line-height:26px;">&quot;force&quot;</span> the microtask queue to be flushed by adding an empty timer.
<span></span>    <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (isIOS) { setTimeout(noop); }
<span></span>  };
<span></span>} <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> {
<span></span>  // fallback to macro
<span></span>  microTimerFunc = macroTimerFunc;
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">如果不支持<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">Promise</code>，那么<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">microTimerFunc = macroTimerFunc;</code>。</p> <h3 data-tool="mdnice编辑器" style="margin-top:30px;margin-bottom:15px;padding:0px;color:black;font-size:16px;font-weight:bold;text-align:center;"><span class="prefix" style="display:none;"></span><span class="content" style="border-bottom:2px solid #DEC6FB;color:#595959;">4. nextTick</span><span class="suffix" style="display:none;"></span></h3> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">最后，真正的看一下<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>函数的主体</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">export</span> <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">function</span> nextTick (cb?: Function, ctx?: Object) {
<span></span>  <span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">let</span> _resolve
<span></span>  callbacks.push(() =&gt; {
<span></span>    <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (cb) {
<span></span>      try {
<span></span>        cb.call(ctx)
<span></span>      } catch (e) {
<span></span>        handleError(e, ctx, <span class="hljs-string" style="color:#D69D85;line-height:26px;">'nextTick'</span>)
<span></span>      }
<span></span>    } <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">else</span> <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (_resolve) {
<span></span>      _resolve(ctx)
<span></span>    }
<span></span>  })
<span></span>  // 忽略
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>函数会在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组中添加一个新的函数，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组定义在文件头部：<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">const callback = []</code>。注意并不是将cb回调函数直接添加到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组中，会使用一个新的函数包裹回调函数并将新函数添加到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组中。但这个被添加到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组中的函数执行会间接调用cd回调函数，并且可以看到cb函数时使用<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">.call</code>方法将函数cb的作用域设置为<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">ctx</code>，也就是<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>函数的第二个参数。所以对于<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法来讲，传递给<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法的回调函数的作用域是当前组件实例对象，前提是回调函数不能是箭头函数，其实在平时的使用中，回调函数使用箭头函数也没关系，只要达到目的就行。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>继续看源码<span>」</span></strong></p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">export</span> <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">function</span> nextTick (cb?: Function, ctx?: Object) {
<span></span>  ...
<span></span>  <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">if</span> (!pending) {
<span></span>    pending = <span class="hljs-literal" style="color:#569CD6;line-height:26px;">true</span>
<span></span>    timerFunc()
<span></span>  }
<span></span>  ...
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">进行一个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">if</code>条件判断，判断<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">pending</code>的真假，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">pending</code>变量定义在文件头部：<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">let pending = false</code>，它是一个标识，它的真假代表回调队列是否处于等待刷新的状态，初始值为<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">false</code>代表回调队列为空不需要等待刷新。假如此时在某个地方调用了<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法，那么<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">if</code>语句块内的代码将会被执行，在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">if</code>语句块内优先将变量<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">pending</code>的值设置为<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">true</code>，代表着此时回调队列不为空，正在等待刷新。既然等待刷新，那么当然要刷新回调队列。这时就用到前面的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">timerFunc</code>函数。在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">week</code>中则是<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">micTimeFunc</code>或者<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">marcoTaskFunc</code>。无论是哪种任务类型，它们都将会等待调用栈清空之后才执行。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>举例：<span>」</span></strong></p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">created</span></span> () {
<span></span>    this.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span>( () =&gt; {console.log(1)})
<span></span>    this.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span>( () =&gt; {console.log(2)})
<span></span>    this.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span>( () =&gt; {console.log(3)})
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">created</code>钩子函数中连续调用三次<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法，但只有第一次调用<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法时才会执行<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">timerFunc</code>函数将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>注册为微任务，但此时<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数并不会执行，因为它要等待接下来的两次<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法的调用语句执行完后才会执行，准确的说等待调用栈被清空之后才会进行。也就是说<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数执行的时候，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>回调队列中将包含本次事件循环所收集的所有通过<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法注册的回调，而接下来的任务就是在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数内将这些回调全部执行并清空。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;"><strong style="color:#595959;font-weight:bold;"><span>「</span>下面是<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>的源码<span>」</span></strong></p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-keyword" style="color:#569CD6;line-height:26px;">function</span> <span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">flushCallbacks</span></span> () {
<span></span>  pending = <span class="hljs-literal" style="color:#569CD6;line-height:26px;">false</span>
<span></span>  const copies = callbacks.slice(0)
<span></span>  callbacks.length = 0
<span></span>  <span class="hljs-keyword" style="color:#569CD6;line-height:26px;">for</span> (<span class="hljs-built_in" style="color:#4EC9B0;line-height:26px;">let</span> i = 0; i &lt; copies.length; i++) {
<span></span>    copies[i]()
<span></span>  }
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">首先将变量<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">pending</code>设置为<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">false</code>，接着开始执行回调，但需要注意的是在执行<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>队列中的回调函数时并没有直接遍历<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组，而是使用<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">copies</code>常量保存一份复制品。然后遍历<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">copies</code>数组，并且在遍历<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">copies</code>数值之前将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组清空：<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks.length = 0。</code></p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">为什么要这样做呢？<strong style="color:#595959;font-weight:bold;"><span>「</span>举个例子<span>」</span></strong></p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;"><span class="hljs-function" style="color:#DCDCDC;line-height:26px;"><span class="hljs-title" style="color:#DCDCDC;line-height:26px;">created</span></span> () {
<span></span>    this.age = 20
<span></span>    this.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span>(() =&gt; {
<span></span>        this.age = 21
<span></span>        this.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span>(() =&gt; { console.log(<span class="hljs-string" style="color:#D69D85;line-height:26px;">'第二个nextTick'</span>)})
<span></span>    })
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">在<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick()</code>的回调函数中再次调用了<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法，理论上外层<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法的回调函数不应该与内层<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>的回调函数在同一个微任务中被执行，而是两个不同的微任务，虽然在结果上看或许没什么差别，但从设计角度就应该这样做。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">上面代码修改了两次<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">age</code>属性的值，首先将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">age</code>的值修改为<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">20</code>，上面说到Vue在更新<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">DOM</code>时也是异步执行的，这个过程中就是将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushSchedulerQueue</code>添加到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组中</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">callbacks = [
<span></span>    flushSchedulerQueue
<span></span>]
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">同时将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数注册为微任务，所以微任务队列为</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">// 微任务队列
<span></span>[
<span></span>    flushCallbacks
<span></span>]
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">接着调用第一个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>方法，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>会将回调函数添加到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组中，那么此时的<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组如下：</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">callbacks = [
<span></span>    flushSchedulerQueue,
<span></span>    () =&gt; {
<span></span>        this.age = 21
<span></span>        this.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span>(() =&gt; {console.log(<span class="hljs-string" style="color:#D69D85;line-height:26px;">'第二个$nextTick'</span>)})
<span></span>    }
<span></span>]
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">接下来主线程出于空闲状态，开始执行微任务队列，即执行<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数，<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数会按照顺序执行<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组中的函数，首先会执行<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushSchedulerQueue</code>函数，这个函数会遍历<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">queue</code>中所有观察者并重新求值。接着执行如下函数:</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">() =&gt; {
<span></span>    this.age = 21
<span></span>    this.<span class="hljs-variable" style="color:#BD63C5;line-height:26px;">$nextTick</span>(() =&gt; {console.log(<span class="hljs-string" style="color:#D69D85;line-height:26px;">'第二个$nextTick'</span>)})
<span></span>}
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">这个函数是第一个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">$nextTick</code>的回调函数，由于在执行该回调函数之前已经完成了重新求值，所以该回调函数内的代码是能够访问更新后的值。在该回调函数内再次修改<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">age</code>属性的值后，同样会调用<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>函数将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushSchedulerQueue</code>添加到<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">callbacks</code>数组中，但是由于在执行<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数时优先将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">pending</code>的设置为<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">false</code>，所以<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">nextTick</code>函数会将<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数注册为一个新的微任务。此时目的就达成了，队列包含两个微任务。</p> <pre data-tool="mdnice编辑器" class="custom" style="margin-top:10px;margin-bottom:10px;border-radius:5px;box-shadow:rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display:block;background:url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png);height:30px;width:100%;background-size:40px;background-repeat:no-repeat;background-color:#1E1E1E;margin-bottom:-7px;border-radius:5px;background-position:10px 10px;"></span><code class="hljs" style="overflow-x:auto;padding:16px;color:#DCDCDC;display:block;font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;font-size:12px;-webkit-overflow-scrolling:touch;padding-top:15px;background:#1E1E1E;border-radius:5px;">// 此时微任务队列
<span></span>[
<span></span>    flushCallbacks，
<span></span>    flushCallbacks
<span></span>]
<span></span></code></pre> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">第二个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>函数的一切流程与第一个<code style="font-size:14px;word-wrap:break-word;padding:2px 4px;border-radius:4px;margin:0 2px;background-color:rgba(27,31,35,.05);font-family:Operator Mono, Consolas, Monaco, Menlo, monospace;word-break:break-all;color:#595959;">flushCallbacks</code>是完全相同的。</p> <p data-tool="mdnice编辑器" style="padding-top:8px;padding-bottom:8px;line-height:26px;color:#595959;margin:10px 0px;letter-spacing:2px;font-size:14px;word-spacing:2px;">以上，$nextTick()就介绍完毕。</p></section></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/FEBlog/assets/js/app.b158500d.js" defer></script><script src="/FEBlog/assets/js/2.7d7fb6cb.js" defer></script><script src="/FEBlog/assets/js/30.68fadd92.js" defer></script>
  </body>
</html>

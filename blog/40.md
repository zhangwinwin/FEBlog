---
# ä¸»é¢˜åˆ—è¡¨ï¼šjuejin, github, smartblue, cyanosis, channing-cyan, fancy, hydrogen, condensed-night-purple, greenwillow, v-green, vue-pro, healer-readable, mk-cute
# è´¡çŒ®ä¸»é¢˜ï¼šhttps://github.com/xitu/juejin-markdown-themes
theme: channing-cyan
highlight: atom-one-dark
---

## å‰è¨€
å…¨æ–¹ä½çš„ä»‹ç»å¦‚ä½•ä½¿ç”¨`JEST`æµ‹è¯•ä¸€ä¸ªVUEç»„ä»¶ã€‚  
ï¼ˆå¦‚æœä¸çŸ¥é“æ€ä¹ˆå¼€å§‹`VUE`å•å…ƒæµ‹è¯•çš„åŒå­¦ä»¬ï¼Œè¯·æŸ¥çœ‹ä¹‹å‰çš„æ–‡ç« [VUEå•å…ƒæµ‹è¯•--å¼€å¯æµ‹è¯•ä¹‹æ—…](https://juejin.cn/post/6906295144505409549)ï¼‰

ç€é‡ä»‹ç»åœ¨ä½¿ç”¨`Vue.extend`åˆ›å»ºæ„é€ å‡½æ•°çš„å½¢å¼æ³¨å†Œçš„ç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼š
* æµ‹è¯•å®šæ—¶å™¨å‡½æ•°
* æµ‹è¯•`HTTP`è¯·æ±‚
* æµ‹è¯•äº‹ä»¶
ç­‰è¿™å‡ ä¸ªéƒ¨åˆ†çš„ä»‹ç»

ä»£ç åœ¨[github](https://github.com/zhangwinwin/FEBlog/tree/master/unitest)æ¬¢è¿ç‚¹èµğŸ‘

## æµ‹è¯•ç»„ä»¶
æµ‹è¯•ç»„ä»¶ï¼Œå…¶å®å°±æ˜¯æµ‹è¯•ç»„ä»¶çš„æ–¹æ³•ä»¥åŠæ–¹æ³•æ‰€ä¾èµ–çš„æ¨¡å—ã€‚  
æµ‹è¯•ç»„ä»¶æ–¹æ³•å¾ˆç®€å•ï¼šè°ƒç”¨ç»„ä»¶æ–¹æ³•å¹¶æ–­è¨€æ–¹æ³•èƒ½ç”¨æ­£ç¡®åœ°å½±å“äº†ç»„ä»¶çš„è¾“å‡ºå³å¯ã€‚

ä»ä¸€ä¸ªä¾‹å­å‡ºå‘ï¼Œæµ‹è¯•ä¸€ä¸ªè¿›åº¦æ¡ç»„ä»¶
```
<template>
  <div class="Progress-Bar" :class="{hidden: hidden}">
  </div>
</template>

<script>
export default {
  name: 'ProgressBar',
  data () {
    return {
      hidden: true
    }
  },
  methods: {
    start () {
      this.hidden = false;
    },
    finally () {
      this.hidden = true;
    }
  },
}
</script>
```
ä»£ç ä¸€ç›®äº†ç„¶ï¼Œå½“è°ƒç”¨`start`æ–¹æ³•æ—¶ï¼Œåº”è¯¥å±•ç¤ºè¿›åº¦æ¡ï¼›å½“è°ƒç”¨`finally`æ–¹æ³•æ—¶ï¼Œåº”è¯¥å±è”½è¿›åº¦æ¡ã€‚
```
import { shallowMount } from '@vue/test-utils';
import ProgressBar from '@/views/ProgressBar.vue';

describe('test progress', () => {
  it('when start is clicked, show the progressBar', () => {
    const wrapper = shallowMount(ProgressBar);
    expect(wrapper.classes()).toContain('hidden');
    wrapper.vm.start();
    wrapper.vm.finally();
    expect(wrapper.classes()).toContain('hidden');
  })
})
```
è¿è¡Œ`yarn test:unit`æ—¶ï¼Œæµ‹è¯•é€šè¿‡ã€‚

è¿™æ˜¯ç®€å•çš„ç»„ä»¶æµ‹è¯•ã€‚

### Vueå®ä¾‹æ·»åŠ å±æ€§
äº‹å®ä¸Šè¿˜æœ‰ä¸€ç§éå¸¸å¸¸è§çš„ç»„ä»¶æ¨¡å¼ï¼Œå°±æ˜¯å¾€`Vue`å®ä¾‹æ·»åŠ å±æ€§ã€‚åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ä¹Ÿä»‹ç»è¿‡ï¼Œç”¨è¿™[VUEçš„â€œåŠ¨æ€â€æ¡ˆä¾‹](https://juejin.cn/post/6893303835251441677)ä»‹ç»çš„ç»„ä»¶æ¥åšä¾‹å­ï¼Œç»„ä»¶çš„å…·ä½“å¼€å‘å°±ä¸å¤šä½œä»‹ç»äº†ï¼Œä»£ç åœ¨ä»£ç åœ¨[github](https://github.com/zhangwinwin/FEBlog/tree/master/unitest)ä¸­ã€‚  
ï¼ˆè¿›å…¥åˆ°`unitest`æ–‡ä»¶å¤¹ä¸­ï¼Œè¿è¡Œ`yarn serve`ã€‚ï¼‰

åŠŸèƒ½ï¼šç‚¹å‡»æŒ‰é’®è§¦å‘`handleCheck`äº‹ä»¶ï¼Œå¼¹å‡º`alarm`å¼¹çª—ï¼Œå¼¹çª—`id`å°±æ˜¯åœ¨`primaryId`åŸºç¡€ä¸Šå¢åŠ 1ã€‚  
æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹ï¼š
```
describe('test alarm', () => {
  it('when handleCheck is clicked, show the alarm', () => {
    const wrapper = shallowMount(Home);
    const count = wrapper.vm.primaryId;
    wrapper.vm.handleCheck();
    const newCount = wrapper.vm.primaryId;
    expect(newCount).toBe(count + 1)
  })
})
```
è¿è¡Œ`yarn test:uni`æ—¶ä¼šå‘ç”Ÿé”™è¯¯
![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/512eb096fd1844b49c8900c436e0f67e~tplv-k3u1fbpfcp-watermark.image)

è¿™æ˜¯å› ä¸ºåœ¨æµ‹è¯•ä¸­ç›´æ¥æŒ‚è½½äº†ç»„ä»¶ï¼Œè€Œè¿™ä¸ªç»„ä»¶å®ä¾‹æ˜¯ä½¿ç”¨`Vue.extend`å‡½æ•°åˆ›å»ºçš„ï¼Œå¹¶åœ¨`main.js`å¼•å…¥å’Œæ·»åŠ åˆ°`Vue`çš„åŸå‹ä¸­çš„ã€‚æ¢è€Œè¨€ä¹‹ï¼Œ`main.js`å¹¶æ²¡æœ‰è¢«æ‰§è¡Œï¼Œè¿™ä¸ªç»„ä»¶å°±æ²¡æœ‰è¢«åˆ›å»ºï¼Œ`$alarm`å±æ€§å°±æ°¸è¿œä¸ä¼šè¢«æ·»åŠ ã€‚
![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/696f8ef28fe34eeb940d479d2a28e1a1~tplv-k3u1fbpfcp-watermark.image)

è¿™æ—¶éœ€è¦åœ¨åŠ è½½ç»„ä»¶åˆ°æµ‹è¯•ä¹‹å‰å…ˆä¸º`Vue`å®ä¾‹æ·»åŠ å±æ€§ã€‚å¯ä»¥ä½¿ç”¨`mocks`æ¥å®ç°ã€‚
```
shallowMount(Home, {
  mocks: {
    $alarm: () => {}
  }
})
```
å†æ¬¡è¿è¡Œ`yarn test:uni`æ—¶å°±å®Œç¾çš„é€šè¿‡äº†ã€‚

### æµ‹è¯•å®šæ—¶å™¨å‡½æ•°
å®šæ—¶å™¨å‡½æ•°åŒ…æ‹¬`JavaScript`å¼‚æ­¥å‡½æ•°éƒ½æ˜¯å‰ç«¯ä¸­å¸¸è§çš„åŠŸèƒ½ï¼Œæ‰€ä»¥éƒ½éœ€è¦æµ‹è¯•å¯¹åº”çš„ä»£ç ã€‚ä½†è‚¯å®šä¸æ˜¯ç­‰å¾…å®šæ—¶å™¨å‡½æ•°èµ°å®Œï¼Œéœ€è¦ä½¿ç”¨`Jest.useFakeTimers`æ›¿æ¢å…¨å±€å®šæ—¶å™¨å‡½æ•°ï¼Œæ›¿æ¢åå¯ä»¥ä½¿ç”¨`runTimersToTime`æ¨è¿›æ—¶é—´ã€‚

#### æµ‹è¯•setTimeout
åŠŸèƒ½ï¼š`handleCheck`äº‹ä»¶è§¦å‘åï¼Œä¼šå°†`alarm`ç»„ä»¶`id unshift`åˆ°`idList`æ•°ç»„ä¸­ï¼Œå¼¹å‡º3ç§’åç»„ä»¶å°±ä¼šè¢«é”€æ¯ï¼Œ`idList`ä¹Ÿä¼šå°†å…¶`id`ç»™åˆ é™¤æ‰ã€‚  
æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹ï¼š
```
it('when handleCheck is clicked, 3second later alarm would be disappeared', () => {
  // æµ‹è¯•ä¹‹å‰ï¼Œæ›¿æ¢å…¨å±€å®šæ—¶å‡½æ•°
  jest.useFakeTimers();
  const wrapper = shallowMount(Home, {
    mocks: {
      $alarm: () => {}
    }
  });
  wrapper.vm.handleCheck();
  expect(wrapper.vm.idList.length).toBe(1);
  // å°†æ—¶é—´æ¨è¿›3000æ¯«ç§’
  jest.runTimersToTime(3000);
  expect(wrapper.vm.idList.length).toBe(0);
})
```

#### æµ‹è¯•clearTimeout
åŠŸèƒ½ï¼šå½“`alarm`å¼¹çª—è¶…è¿‡ä¸€ä¸ªçš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨`clearTimeout`é”€æ¯å‰ä¸€ä¸ªçš„`timer`ã€‚è¿™æ—¶å°±è¦ç›‘å¬`clearTimeout`æ˜¯å¦è¢«è°ƒç”¨ã€‚

ä½¿ç”¨`Jest.spyOn`å‡½æ•°åˆ›å»ºä¸€ä¸ª`spy`ï¼Œå¯ä»¥ä½¿ç”¨`toHaveBeenCalled`åŒ¹é…å™¨æ¥æ£€æµ‹`spy`æ˜¯å¦è¢«è°ƒç”¨ï¼Œæ›´è¿›ä¸€æ­¥åœ°å¯ä»¥ä½¿ç”¨`toHaveBeenCalledWith`åŒ¹é…å™¨æµ‹è¯•`spy`æ˜¯å¦å¸¦æœ‰æŒ‡å®šå‚æ•°è¢«è°ƒç”¨ã€‚

æ‰€ä»¥åœ¨æµ‹è¯•ä¸­ï¼Œéœ€è¦å¾—åˆ°`setTimeout`çš„è¿”å›å€¼ï¼Œ`Jest.mockReturnValue`å¯ä»¥å®ç°è¿™ä¸ªéœ€æ±‚ã€‚`mockReturnValue`å¯ä»¥å°†`setTimeout`çš„è¿”å›å€¼è®¾ç½®ä¸ºä»»ä½•å€¼ï¼Œæ¯”å¦‚å°†è¿”å›å€¼è®¾ç½®ä¸º123ï¼š`setTimeOut.mockReturnValue(123)`  
æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹ï¼š
```
it('when handleCheck is clicked and the number of alarm exceeds 1 , The previous alarm disappears immediately', () => {
    // ç›‘å¬clearTimeout
    jest.spyOn(window, 'clearTimeout')
    const wrapper = shallowMount(Home, {
      mocks: {
        $alarm: () => {}
      }
    });
    // è®¾ç½®setTimeoutè¿”å›å€¼ä¸º123
    setTimeout.mockReturnValue(123)
    wrapper.vm.handleCheck();
    // è®¾ç½®setTimeoutè¿”å›å€¼ä¸º456
    setTimeout.mockReturnValue(456)
    wrapper.vm.handleCheck();
    expect(window.clearTimeout).toHaveBeenCalledWith(123)
  })
```

### æµ‹è¯•æ¨¡æ‹ŸHTTPè¯·æ±‚
`HTTP`è¯·æ±‚ä¸åœ¨å•å…ƒæµ‹è¯•èŒƒå›´ï¼Œå› ä¸ºå®ƒä¼šé™ä½å•å…ƒæµ‹è¯•çš„é€Ÿåº¦ï¼›é™ä½å•å…ƒæµ‹è¯•çš„å¯é æ€§ï¼Œå› ä¸º`HTTP`è¯·æ±‚ä¸ä¼š100%è¯·æ±‚æˆåŠŸã€‚æ‰€ä»¥éœ€è¦åœ¨å•å…ƒæµ‹è¯•ä¸­æ¨¡æ‹Ÿ`api`æ–‡ä»¶ï¼Œä»è€Œä½¿å¾—`fetchAlarmDetail`æ°¸è¿œä¸ä¼šå‘é€ä¸€ä¸ª`HTTP`è¯·æ±‚ã€‚

`Jest`æä¾›äº†ä¸€ä¸ª`API`ï¼Œç”¨äºé€‰æ‹©å½“ä¸€ä¸ªæ¨¡å—å¯¼å…¥å¦ä¸€ä¸ªæ¨¡å—æ—¶è¿”å›å“ªäº›æ–‡ä»¶æˆ–å‡½æ•°ã€‚é¦–å…ˆçš„åˆ›å»ºä¸€ä¸ª`mock`æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨æµ‹è¯•ä¸­å¼•å…¥çœŸæ­£çš„æ–‡ä»¶ã€‚

åœ¨`api`ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª`__mocks__`ç›®å½•ï¼Œé‡Œé¢åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„éœ€è¦æµ‹è¯•çš„`alarmApi`æ–‡ä»¶
```
// src/api/__mocks__/alarmApi.js
export const fetchAlarmDetail = jest.fn(() => Promise.resolve('äººæœº'));
```
ç„¶ååœ¨æµ‹è¯•æ–‡ä»¶ä¸­åŠ å…¥
```
// alarm.spec.js
jest.mock('../../src/api/alarmApi.js');
```

è°ƒç”¨`jest.mock('../../src/api/alarmApi.js')`åï¼Œå½“æ¨¡å—å¯¼å…¥äº†`src/api/alarmApi.js`åï¼Œ`Jest`å°†ä½¿ç”¨åˆ›å»ºçš„`mock`æ–‡ä»¶è€Œä¸æ˜¯åŸæ–‡ä»¶ã€‚

æµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹ï¼š
```
it('fetch the alarm detail by http', async () => {
  // è®¾ç½®æ–­è¨€æ•°é‡ï¼Œå¦‚æœä¸€ä¸ªpromiseè¢«æ‹’ç»ï¼Œæµ‹è¯•ä¼šå¤±è´¥
  expect.assertions(1);
  const name = await alarmApi.fetchAlarmDetail();
  expect(name).toBe('äººæœº')
})
```
è®¾ç½®æ–­è¨€æ•°é‡æ˜¯åœ¨å¼‚æ­¥æµ‹è¯•ä¸­éå¸¸å¸¸ç”¨çš„æ–¹æ³•ï¼Œå› ä¸ºè¿™å¯ä»¥ç¡®ä¿åœ¨æµ‹è¯•ç»“æŸå‰æ‰§è¡Œå®Œæ‰€æœ‰æ–­è¨€ã€‚

#### åœ¨ç»„ä»¶ä¸­è°ƒç”¨HTTPè¯·æ±‚å‡½æ•°
ä¸€èˆ¬æ¥è¯´ï¼Œ`HTTP`è¯·æ±‚æ˜¯åœ¨ç»„ä»¶ä¸­ä½¿ç”¨çš„ï¼Œå•ç‹¬æµ‹è¯•ä½œç”¨å¹¶ä¸å¤§ã€‚é‚£ä¹ˆåœ¨ç»„ä»¶ä¸­è½½å…¥å…¶ä»–å¼‚æ­¥ä¾èµ–ï¼Œåº”è¯¥æ€ä¹ˆå»æµ‹è¯•å‘¢ï¼Ÿ

é¦–å…ˆåœ¨`home.vue`ä¸­å¯¼å…¥è¯·æ±‚æ–‡ä»¶
```
import * as alarmApi from '@/api/alarmApi.js';

// åœ¨handleCheckä¸­ä½¿ç”¨
async handleCheck () {
    // ...
    const name = await alarmApi.fetchAlarmDetail();
    // ...
}
```
å½“æµ‹è¯•è°ƒç”¨å¼‚æ­¥ä»£ç çš„æ—¶å€™ï¼Œå¹¶ä¸æ€»æ˜¯å¯ä»¥è®¿é—®éœ€è¦ç­‰å¾…çš„å¼‚æ­¥å‡½æ•°ã€‚è¿™æ„å‘³ç€ä¸èƒ½åœ¨æµ‹è¯•ä¸­ä½¿ç”¨`await`æ¥ç­‰å¾…å¼‚æ­¥å‡½æ•°ç»“æŸã€‚

è¿™æ—¶å¯ä»¥ä½¿ç”¨`flush-promises`åº“æ¥å¸®å¿™ï¼Œå®ƒèƒ½ç­‰å¾…å¼‚æ­¥å‡½æ•°ç»“æŸã€‚ä¾‹å¦‚ï¼š
```
let loading = true;
Promise.resolve().then(() => {
    loading = false;
}
await flushPromise();
expect(loading).toBe(false)
```
åŸºäºæ­¤ï¼Œå°†ä¹‹å‰çš„æµ‹è¯•ç”¨ä¾‹ä¿®æ”¹ä¸ºï¼š
```
// 2.1
  it('when handleCheck is clicked, show the alarm', async () => {
    expect.assertions(1);
    const wrapper = shallowMount(Home, {
      mocks
    });
    const count = wrapper.vm.primaryId;
    alarmApi.fetchAlarmDetail.mockImplementationOnce(() => Promise.resolve('äººæœº'));
    wrapper.vm.handleCheck();
    await flushPromises();
    const newCount = wrapper.vm.primaryId;
    expect(newCount).toBe(count + 1)
  })
```
åŠ å…¥ä¸€ä¸ª`expect.assertions(1)`è®¾ç½®æ–­è¨€æ•°é‡ï¼Œè®¾ç½®`fetchAlarmDetail`å‡½æ•°çš„è¿”å›ç»“æœï¼Œæœ€åè°ƒç”¨`await flushPromises();`ç­‰å¾…æ‰€æœ‰å¼‚æ­¥å‡½æ•°ç»“æŸã€‚ï¼ˆä¹‹åçš„æµ‹è¯•ç”¨ä¾‹ä¿®æ”¹ï¼Œä¸å†å±•å¼€è®¨è®ºï¼Œè¯¦æƒ…è¯·çœ‹ä»£ç ã€‚ï¼‰

åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥`yarn test:uni`
![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cff34a12d99e428c9bb1d62160e7ea63~tplv-k3u1fbpfcp-watermark.image)

### æµ‹è¯•äº‹ä»¶
#### æµ‹è¯•DOMäº‹ä»¶
åŠŸèƒ½ï¼šç‚¹å‡»ä¸€ä¸ªæŒ‰é’®ï¼Œè§¦å‘ä¸€ä¸ª`click`äº‹ä»¶
æµ‹è¯•ç”¨ä¾‹ï¼š
```
it('click the button then the $alarm will be called', () => {
  const wrapper = shallowMount(Home, {
    mocks
  });
  wrapper.find('button.check').trigger('click');
  expect($alarm).toHaveBeenCalled();
})
```
æ¯ä¸ªåŒ…è£…å™¨éƒ½æœ‰ä¸€ä¸ª`trigger`æ–¹æ³•ï¼Œç”¨äºåœ¨åŒ…è£…å™¨ä¸Šåˆ†å‘ä¸€ä¸ªäº‹ä»¶ã€‚
```
// é”®ç›˜äº‹ä»¶
wrapper.trigger('keydown.up')ï¼›
wrapper.trigger('keydown', {
  key: 'a'
})
// é¼ æ ‡äº‹ä»¶
wrapper.trigger('mouseenter')ï¼›
```

#### æµ‹è¯•è‡ªå®šä¹‰äº‹ä»¶
`VUE`è‡ªå®šä¹‰äº‹ä»¶æ˜¯ç”±å¸¦æœ‰`VUE`å®ä¾‹`$emit`æ–¹æ³•çš„ç»„ä»¶äº‹ä»¶å‘å°„å‡ºå»çš„ã€‚åœ¨å­ç»„ä»¶ä¸­å‘å°„ä¸€ä¸ªäº‹ä»¶ï¼š
```
// son.vue
this.$emit('eventName', payload);
```
åœ¨çˆ¶ç»„ä»¶ä¸­æ¥æ”¶ä¸€ä¸ªäº‹ä»¶ï¼š
```
// father
<son @eventName='handleEvent'></son>
```
åŠŸèƒ½ï¼š ç‚¹å‡»ä½äº`HelloWorld`ç»„ä»¶çš„`class`ä¸º`hello`çš„`button`å…ƒç´ ï¼Œè§¦å‘`sayHello`äº‹ä»¶å¹¶æºå¸¦`hello`ã€‚ä½äº`Home`ç»„ä»¶çš„`handleSayHello`è§¦å‘ï¼Œå°†`greeting`ä»`hi`å˜æˆ`hello`ã€‚
```
it('click the check button, home.greeting will change to hello', () => {
    const wrapper = shallowMount(Home);
    wrapper.findComponent(Hello).vm.$emit('sayHello', 'hello');
    expect(wrapper.vm.greeting).toBe('hello')
  })
```
## ç»“å°¾
é˜…è¯»å®Œï¼Œå¦‚æœè§‰å¾—æœ‰å¸®åŠ©çš„è¯·ç‚¹ç‚¹èµï¼Œæ”¯æŒä¸€ä¸‹ã€‚

æ›´å¤šæ–‡ç« è¯·ç§»æ­¥[æ¥¼ä¸»github](https://github.com/zhangwinwin/FEBlog),å¦‚æœå–œæ¬¢è¯·ç‚¹ä¸€ä¸‹star,å¯¹ä½œè€…ä¹Ÿæ˜¯ä¸€ç§é¼“åŠ±ã€‚





(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{456:function(t,e,a){"use strict";a.r(e);var v=a(57),s=Object(v.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[t._v("前言")]),t._v(" "),a("p",[t._v("当下载电影时，我常常会想中断下载后，为什么点击开始时会在中断的地方继续下载呢？"),a("br"),t._v("\n又或者在看在线电影时，为什么可以按着播放条拖动就能看到想看的片段呢？")]),t._v(" "),a("p",[t._v("http的"),a("strong",[t._v("range")]),t._v("请求将解决以上困惑。")]),t._v(" "),a("h2",{attrs:{id:"多线程、断点续传、随机点播等的场景的步骤"}},[t._v("多线程、断点续传、随机点播等的场景的步骤")]),t._v(" "),a("p",[t._v("1、客户端明确任务：从哪开始下载")]),t._v(" "),a("ul",[a("li",[t._v("本地是否已有部分文件：文件已下载部分在服务器端发生改变？")]),t._v(" "),a("li",[t._v("使用几个线程并发下载")])]),t._v(" "),a("p",[t._v("2、下载文件的指定部分内容"),a("br"),t._v("\n3、下载完毕后拼装成统一的文件")]),t._v(" "),a("h2",{attrs:{id:"http-range规范"}},[t._v("HTTP Range规范")]),t._v(" "),a("p",[t._v("在RFC7233中有详细介绍"),a("br"),t._v("\n1、允许服务器基于客户端的请求只发送响应包体的一部分给到客户端，而客户端自动将多个片段的包体组合成完整的体积更大的包体。")]),t._v(" "),a("ul",[a("li",[t._v("支持断点续传")]),t._v(" "),a("li",[t._v("支持多线程下载")]),t._v(" "),a("li",[t._v("支持视频播放器实时拖动")])]),t._v(" "),a("p",[t._v("2、服务器通过Accept-Range头部表示是否支持Range请求")]),t._v(" "),a("ul",[a("li",[t._v("Accept-Ranges = acceptable-ranges")]),t._v(" "),a("li",[t._v("例如:"),a("br"),t._v("\nAccept-Ranges: bytes: 支持；"),a("br"),t._v("\nAccept-Ranges: none: 不支持")])]),t._v(" "),a("h2",{attrs:{id:"range请求范围的单位"}},[t._v("Range请求范围的单位")]),t._v(" "),a("p",[t._v("基于字节为单位的时候，举例：设置响应体长度为10000")]),t._v(" "),a("ul",[a("li",[t._v("第1个500字节："),a("br"),t._v("\nbytes=0-499 // 从0开始")]),t._v(" "),a("li",[t._v("第2个500字节："),a("br"),t._v("\nbytes=500-999"),a("br"),t._v("\nbytes=500-600, 601-999"),a("br"),t._v("\nbytes=500-700, 601-999")]),t._v(" "),a("li",[t._v("最后1个500字节"),a("br"),t._v("\nbytes=-500"),a("br"),t._v("\nbytes=9500-")]),t._v(" "),a("li",[t._v("仅要第一个和最后一个字节：bytes=0-0, -1")])]),t._v(" "),a("p",[t._v("通过Range头部传递请求范围，如：Range: bytes=0-499")]),t._v(" "),a("h3",{attrs:{id:"测试"}},[t._v("测试")]),t._v(" "),a("p",[t._v("下面用一些小例子有测试一下。"),a("br"),t._v("\n用node搭了一个简单的服务器，返回的数字是22个字节的响应体")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("'Hello World 0123456789';\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("现在用curl命令获取全部的响应体，然后访问0-5的字节段：\n"),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/17024308e77fe71a~tplv-t2oaga2asx-image.image",width:"500"}})]),t._v(" "),a("p",[t._v("-H参数添加 HTTP 请求的标头。"),a("br"),t._v("\n上面的命令就是添加HTTP头Range: bytes=0-5。"),a("br"),t._v("\n返回的是Hello (加上空格)一共六个字节。")]),t._v(" "),a("p",[t._v("现在获取第21个字节及以后的字节段，就可以用20-：\n"),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/1702433d07573559~tplv-t2oaga2asx-image.image",width:"500"}}),a("br"),t._v("\n返回的是89")]),t._v(" "),a("h2",{attrs:{id:"range条件请求"}},[t._v("Range条件请求")]),t._v(" "),a("ul",[a("li",[t._v("如果客户端已经得到了Range响应的一部分，并想在这部分响应未过期的情况下，获取其他部分的响应"),a("br"),t._v("\n常与If-Unmodified-Since或者If-Match头部共同使用")]),t._v(" "),a("li",[t._v("If-Range = entity-tag / HTTP-date"),a("br"),t._v("\n可以使用Etag或者Last-Modified")])]),t._v(" "),a("h3",{attrs:{id:"测试-2"}},[t._v("测试")]),t._v(" "),a("p",[t._v("下面用etag测试一下Range条件请求")]),t._v(" "),a("p",[t._v("首先获取0-5字节段"),a("br"),t._v(" "),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/17024308e77fe71a~tplv-t2oaga2asx-image.image",width:"500"}})]),t._v(" "),a("p",[t._v("然后用-I来看看生成Hello 时服务器生成Etag的值\n"),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/170243fddd82ee8e~tplv-t2oaga2asx-image.image",width:"500"}})]),t._v(" "),a("p",[t._v("接下来，用这个值放到If-Match中获取6-10字节段：World\n"),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/1702442b74d27864~tplv-t2oaga2asx-image.image",width:"500"}})]),t._v(" "),a("p",[t._v("如果Etag发生了变化，来看看结果会怎么样,将最后的0改为1\n"),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/1702462dd88d06b5~tplv-t2oaga2asx-image.image",width:"500"}}),a("br"),t._v("\n返回412 Precondition Failed")]),t._v(" "),a("h3",{attrs:{id:"结论"}},[t._v("结论")]),t._v(" "),a("p",[t._v("通过条件请求可以判断两次下载之间，服务器端资源有没有发生变化。如果发生了变化，就可以通过412这个响应知道，资源已经发生了变化。")]),t._v(" "),a("h2",{attrs:{id:"服务器响应"}},[t._v("服务器响应")]),t._v(" "),a("p",[t._v("如果只获取部分的body，那么服务器端返回的响应码不是200，而是206。"),a("br"),t._v("\n206 Partial Content")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("Content-Range头部：显示当前片段响应体在完整包体中的位置")])]),t._v(" "),a("li",[a("p",[t._v("Content-Range = byte-content-range / other-content-range"),a("br"),t._v("\n{ btye-content-range = bytes-unit SP (byte-range-resp / unsatisfied-range)"),a("br"),t._v("\nbyte-range-resp = byte-range '/' (complete-length / '"),a("em",[t._v("')"),a("br"),t._v("\ncomplete-length = 1")]),t._v("DIGIT // 完整资源的大小，如果未知则用*号替代"),a("br"),t._v('\nbytr-range = first-byte-pos "-" last-byte-pos }')])]),t._v(" "),a("li",[a("p",[t._v("例如："),a("br"),t._v("\n1、Content-Range: bytes 42-1233/1234"),a("br"),t._v("\n2、Content-Range: bytes 42-1233/*")])])]),t._v(" "),a("h3",{attrs:{id:"测试-3"}},[t._v("测试")]),t._v(" "),a("p",[t._v("用一个视频播放的例子来看看206响应的样子。\n"),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/17024f07e05e3dd8~tplv-t2oaga2asx-image.image",alt:""}})]),t._v(" "),a("p",[t._v("416 Range Not Statisfiable")]),t._v(" "),a("ul",[a("li",[t._v("请求范围不满足实际资源的大小，其中Content-Range中的complete-length显示完整响应的长度，例如"),a("br"),t._v("\nContent-Range: bytes */1234")])]),t._v(" "),a("h3",{attrs:{id:"测试-4"}},[t._v("测试")]),t._v(" "),a("p",[t._v("如果获取范围超出实际资源的大小，比如获取30-40。返回416\n"),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/17024f86b1c2627d~tplv-t2oaga2asx-image.image",alt:""}})]),t._v(" "),a("p",[t._v("200 OK")]),t._v(" "),a("ul",[a("li",[t._v("服务器不支持Range请求时，则以200返回完整的响应包体")])]),t._v(" "),a("h2",{attrs:{id:"多重范围与multipart"}},[t._v("多重范围与multipart")]),t._v(" "),a("ul",[a("li",[t._v("请求："),a("br"),t._v("\nRange: bytes=0-50, 100-150")]),t._v(" "),a("li",[t._v("响应:"),a("br"),t._v("\nContent-Type: multipart/byteranges; boundary=...")])]),t._v(" "),a("h3",{attrs:{id:"测试-5"}},[t._v("测试")]),t._v(" "),a("p",[t._v("获取5-10， 10-15片段。\n"),a("img",{attrs:{src:"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/2/8/17024fb9b1b267e9~tplv-t2oaga2asx-image.image",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"总结"}},[t._v("总结")]),t._v(" "),a("p",[t._v("1、客户端通过Range头部传递请求范围")]),t._v(" "),a("p",[t._v("2、服务端返回Accept-Range头部表示是否支持Range请求。")]),t._v(" "),a("p",[t._v("3、客户端如果在得到Range响应的一部分，并想在这部分响应未过期的情况下，获取其他部分的响应，可以用If-Range头部使用Etag或者Last-Modified为值。")]),t._v(" "),a("p",[t._v("4、只获取部分的body，服务器返回206响应码，其中Content-Range头部显示当前片段响应体在完整包体中的位置")]),t._v(" "),a("p",[t._v("5、客户端想多重范围下载资源，在Range头部的格式为Range: bytes=0-50, 100-150...(用逗号分隔)"),a("br"),t._v("\n响应头部Content-Type: multipart/byteranges; boundary=...")])])}),[],!1,null,null,null);e.default=s.exports}}]);